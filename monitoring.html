<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>컨텐츠 모니터링 - 운영관리팀</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .page-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 25px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 60px 40px;
            position: relative;
        }

        .page-header h1 {
            font-size: 3.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            text-shadow: 0 3px 6px rgba(0,0,0,0.2);
            letter-spacing: -1px;
        }

        .page-header h2 {
            font-size: 1.6rem;
            font-weight: 300;
            opacity: 0.9;
            letter-spacing: 0.5px;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .main-content {
            padding: 60px 50px;
            background: linear-gradient(135deg, #f8fbff 0%, #f1f7ff 100%);
        }

        .controls-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .table-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .add-row-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }

        .add-col-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .remove-row-btn {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            color: white;
        }

        .remove-col-btn {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .save-controls {
            display: flex;
            gap: 15px;
        }

        .save-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .table-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .monitoring-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        .monitoring-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 15px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
            border: 2px solid #5a67d8;
            position: relative;
        }

        .monitoring-table td {
            padding: 0;
            border: 2px solid #e2e8f0;
            position: relative;
        }

        .cell-input {
            width: 100%;
            padding: 15px;
            border: none;
            outline: none;
            font-size: 1rem;
            font-family: inherit;
            background: transparent;
            transition: all 0.3s ease;
        }

        .cell-input:focus {
            background: #fafbff;
            box-shadow: inset 0 0 0 2px #667eea;
        }

        .name-column {
            width: 25%;
        }

        .company-column {
            width: 50%;
        }

        .regular-column {
            width: 25%;
        }

        .monitoring-table tr:hover {
            background: #f8fafc;
        }

        .column-header {
            position: relative;
            padding-right: 40px;
        }

        .remove-column-btn {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            background: rgba(229, 62, 62, 0.8);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.2s ease;
            display: none;
        }

        .column-header:hover .remove-column-btn {
            display: block;
        }

        .remove-column-btn:hover {
            background: #c53030;
            transform: translateY(-50%) scale(1.1);
        }

        .row-controls {
            position: absolute;
            left: -40px;
            top: 50%;
            transform: translateY(-50%);
            display: none;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 5px;
        }

        .monitoring-table tr:hover .row-controls {
            display: block;
        }

        .remove-row-cell-btn {
            background: #e53e3e;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .remove-row-cell-btn:hover {
            background: #c53030;
            transform: scale(1.1);
        }

        .table-wrapper {
            position: relative;
            margin-left: 50px;
        }

        .save-feedback {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #48bb78;
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            font-weight: 600;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .save-feedback.show {
            transform: translateX(0);
        }

        @media (max-width: 768px) {
            .page-container {
                margin: 10px;
            }
            
            .main-content {
                padding: 30px 20px;
            }

            .controls-section {
                flex-direction: column;
                align-items: stretch;
            }

            .table-controls, .save-controls {
                justify-content: center;
            }

            .table-wrapper {
                margin-left: 0;
            }

            .row-controls {
                position: static;
                display: block;
                margin-bottom: 10px;
                transform: none;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="page-header">
            <a href="index.html" class="back-btn">← 메인으로</a>
            <h1>운영관리팀</h1>
            <h2>컨텐츠 모니터링</h2>
        </div>

        <div class="main-content">
            <div class="controls-section">
                <div class="table-controls">
                    <button class="control-btn add-row-btn" onclick="addRow()">+ 행 추가</button>
                    <button class="control-btn add-col-btn" onclick="addColumn()">+ 열 추가</button>
                    <button class="control-btn remove-row-btn" onclick="removeLastRow()">- 행 삭제</button>
                    <button class="control-btn remove-col-btn" onclick="removeLastColumn()">- 열 삭제</button>
                </div>
                <div class="save-controls">
                    <button class="control-btn save-btn" onclick="saveData()">저장</button>
                </div>
            </div>

            <div class="table-container">
                <div class="table-wrapper">
                    <table class="monitoring-table" id="monitoringTable">
                        <thead id="tableHead">
                            <tr>
                                <th class="name-column">
                                    <div class="column-header">
                                        이름
                                    </div>
                                </th>
                                <th class="company-column">
                                    <div class="column-header">
                                        업체명
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- 동적으로 생성됩니다 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="save-feedback" id="saveFeedback">
        저장되었습니다!
    </div>

    <script>
        let tableData = [];
        let columnCount = 2;
        let rowCount = 5; // 초기 행 수

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initFirebaseConnection();
            initializeTable();
        });

        // Firebase 연결 초기화
        async function initFirebaseConnection() {
            console.log('Firebase 초기화 시작');
            console.log('window.firebaseInitialized:', window.firebaseInitialized);
            console.log('window.db:', window.db);
            
            if (window.firebaseInitialized && window.db) {
                try {
                    const { getDocs, collection, setDoc, doc, onSnapshot } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                    window.getDocs = getDocs;
                    window.collection = collection;
                    window.setDoc = setDoc;
                    window.doc = doc;
                    window.onSnapshot = onSnapshot;
                    
                    console.log('Firebase 함수들 로드 완료');
                    
                    await loadMonitoringFromFirebase();
                    setupRealtimeSync();
                    showSaveFeedback('Firebase 연결 완료!');
                } catch (error) {
                    console.error('Firebase 함수 로드 오류:', error);
                    loadSavedData();
                    showSaveFeedback('Firebase 함수 로드 실패 - 로컬 모드');
                }
            } else {
                console.log('Firebase 초기화되지 않음');
                loadSavedData();
                showSaveFeedback('Firebase 연결 실패 - 로컬 모드');
            }
        }

        // Firebase에서 데이터 불러오기
        async function loadMonitoringFromFirebase() {
            if (!window.db) return false;
            
            try {
                const querySnapshot = await window.getDocs(window.collection(window.db, 'monitoring'));
                let savedData = null;
                
                querySnapshot.forEach((doc) => {
                    if (doc.id === 'tableData') {
                        savedData = doc.data();
                    }
                });
                
                if (savedData) {
                    // 평면화된 데이터를 2차원 배열로 복원
                    const flattenedData = savedData.data || {};
                    columnCount = savedData.columnCount || 2;
                    rowCount = savedData.rowCount || 5;
                    
                    // 2차원 배열 초기화
                    tableData = [];
                    for (let i = 0; i < rowCount; i++) {
                        const row = [];
                        for (let j = 0; j < columnCount; j++) {
                            row.push(flattenedData[`cell_${i}_${j}`] || '');
                        }
                        tableData.push(row);
                    }
                    
                    renderTable();
                } else {
                    initializeTable();
                }
                return true;
            } catch (error) {
                console.error('Firebase 로드 실패:', error);
                loadSavedData();
                return false;
            }
        }

        // Firebase에 저장
        async function saveMonitoringToFirebase() {
            if (!window.db) {
                console.log('Firebase DB 연결 없음');
                return false;
            }
            
            try {
                console.log('Firebase 저장 시도 중...');
                
                // 2차원 배열을 평면화하여 저장
                const flattenedData = {};
                for (let i = 0; i < tableData.length; i++) {
                    for (let j = 0; j < tableData[i].length; j++) {
                        flattenedData[`cell_${i}_${j}`] = tableData[i][j] || '';
                    }
                }
                
                console.log('평면화된 데이터:', flattenedData);
                
                await window.setDoc(window.doc(window.db, 'monitoring', 'tableData'), {
                    data: flattenedData,
                    columnCount: columnCount,
                    rowCount: rowCount,
                    lastUpdated: new Date().toISOString()
                });
                
                console.log('Firebase 저장 성공');
                return true;
            } catch (error) {
                console.error('Firebase 저장 실패:', error);
                return false;
            }
        }

        // 실시간 동기화
        function setupRealtimeSync() {
            if (!window.db) return;
            
            window.onSnapshot(window.collection(window.db, 'monitoring'), (snapshot) => {
                snapshot.forEach((doc) => {
                    if (doc.id === 'tableData') {
                        const data = doc.data();
                        
                        // 평면화된 데이터를 2차원 배열로 복원
                        const flattenedData = data.data || {};
                        columnCount = data.columnCount || 2;
                        rowCount = data.rowCount || 5;
                        
                        // 2차원 배열 초기화
                        tableData = [];
                        for (let i = 0; i < rowCount; i++) {
                            const row = [];
                            for (let j = 0; j < columnCount; j++) {
                                row.push(flattenedData[`cell_${i}_${j}`] || '');
                            }
                            tableData.push(row);
                        }
                        
                        renderTable();
                        showSaveFeedback('실시간 동기화됨!');
                    }
                });
            });
        }

        function initializeTable() {
            // 초기 데이터 구조 생성
            tableData = [];
            for (let i = 0; i < rowCount; i++) {
                const row = [];
                for (let j = 0; j < columnCount; j++) {
                    row.push('');
                }
                tableData.push(row);
            }
            renderTable();
        }

        function renderTable() {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            
            // 헤더 렌더링
            const headerRow = thead.querySelector('tr');
            headerRow.innerHTML = '';
            
            // 기본 컬럼들
            const nameHeader = document.createElement('th');
            nameHeader.className = 'name-column';
            nameHeader.innerHTML = '<div class="column-header">이름</div>';
            headerRow.appendChild(nameHeader);
            
            const companyHeader = document.createElement('th');
            companyHeader.className = 'company-column';
            companyHeader.innerHTML = '<div class="column-header">업체명</div>';
            headerRow.appendChild(companyHeader);
            
            // 추가 컬럼들
            for (let i = 2; i < columnCount; i++) {
                const th = document.createElement('th');
                th.className = 'regular-column';
                th.innerHTML = `
                    <div class="column-header">
                        항목 ${i - 1}
                        <button class="remove-column-btn" onclick="removeColumn(${i})">×</button>
                    </div>
                `;
                headerRow.appendChild(th);
            }
            
            // 바디 렌더링
            tbody.innerHTML = '';
            
            for (let i = 0; i < tableData.length; i++) {
                const row = document.createElement('tr');
                
                for (let j = 0; j < columnCount; j++) {
                    const cell = document.createElement('td');
                    if (j === 0) {
                        cell.className = 'name-column';
                    } else if (j === 1) {
                        cell.className = 'company-column';
                    } else {
                        cell.className = 'regular-column';
                    }
                    
                    cell.innerHTML = `
                        <input type="text" class="cell-input" 
                               value="${tableData[i][j] || ''}" 
                               onchange="updateCell(${i}, ${j}, this.value)"
                               placeholder="${j === 0 ? '이름 입력' : j === 1 ? '업체명 입력' : '내용 입력'}">
                    `;
                    
                    // 첫 번째 셀에 행 삭제 버튼 추가
                    if (j === 0) {
                        cell.innerHTML += `
                            <div class="row-controls">
                                <button class="remove-row-cell-btn" onclick="removeRow(${i})">×</button>
                            </div>
                        `;
                    }
                    
                    row.appendChild(cell);
                }
                
                tbody.appendChild(row);
            }
        }

        function updateCell(rowIndex, colIndex, value) {
            if (!tableData[rowIndex]) {
                tableData[rowIndex] = [];
            }
            tableData[rowIndex][colIndex] = value;
        }

        function addRow() {
            const newRow = [];
            for (let i = 0; i < columnCount; i++) {
                newRow.push('');
            }
            tableData.push(newRow);
            rowCount++;
            renderTable();
        }

        function addColumn() {
            columnCount++;
            // 기존 모든 행에 새 컬럼 추가
            for (let i = 0; i < tableData.length; i++) {
                tableData[i].push('');
            }
            renderTable();
        }

        function removeLastRow() {
            if (tableData.length > 1) {
                tableData.pop();
                rowCount--;
                renderTable();
            }
        }

        function removeLastColumn() {
            if (columnCount > 2) {
                columnCount--;
                // 모든 행에서 마지막 컬럼 제거
                for (let i = 0; i < tableData.length; i++) {
                    tableData[i].pop();
                }
                renderTable();
            }
        }

        function removeRow(index) {
            if (tableData.length > 1) {
                tableData.splice(index, 1);
                rowCount--;
                renderTable();
            }
        }

        function removeColumn(index) {
            if (columnCount > 2) {
                columnCount--;
                // 모든 행에서 해당 컬럼 제거
                for (let i = 0; i < tableData.length; i++) {
                    tableData[i].splice(index, 1);
                }
                renderTable();
            }
        }

        async function saveData() {
            const success = await saveMonitoringToFirebase();
            
            if (!success) {
                localStorage.setItem('monitoringData', JSON.stringify({
                    data: tableData,
                    columnCount: columnCount,
                    rowCount: rowCount
                }));
                showSaveFeedback('오프라인 모드로 저장됨');
            } else {
                showSaveFeedback('데이터가 저장되어 팀원들과 공유되었습니다!');
            }
        }

        function loadSavedData() {
            const saved = localStorage.getItem('monitoringData');
            if (saved) {
                const data = JSON.parse(saved);
                tableData = data.data || [];
                columnCount = data.columnCount || 2;
                rowCount = data.rowCount || 5;
                renderTable();
            } else {
                initializeTable();
            }
        }

        function showSaveFeedback(message) {
            const feedback = document.getElementById('saveFeedback');
            feedback.textContent = message;
            feedback.classList.add('show');
            
            setTimeout(() => {
                feedback.classList.remove('show');
            }, 2000);
        }

        // 키보드 단축키
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveData();
            }
        });
    </script>

    <!-- Firebase SDK 추가 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, setDoc, doc, getDocs, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyA6VSdpxQ2PDkCrezW5n_Y69BVuvA3ig9g",
            authDomain: "soom-brand.firebaseapp.com",
            projectId: "soom-brand",
            storageBucket: "soom-brand.firebasestorage.app",
            messagingSenderId: "765427036681",
            appId: "1:765427036681:web:37add5f9e4fdbb8c30fed8"
        };

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 전역 변수로 설정
        window.db = db;
        window.firebaseInitialized = true;

        console.log('Firebase 연결 완료!');
    </script>
</body>
</html>
